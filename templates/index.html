<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySpotify</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="container">
        <div class="sidebar">
            <div class="logo"><i class="fab fa-spotify"></i> PySpotify</div>
            <ul>
                <li id="nav-home" class="active" onclick="showHome()"><i class="fas fa-home"></i> Home</li>
                <li id="nav-search" onclick="focusSearch()"><i class="fas fa-search"></i> Search</li>
                <li id="nav-library" onclick="showFavourites()"><i class="fas fa-heart"></i> Favourites</li>
            </ul>
        </div>

        <div class="main-content">
            <div class="search-bar-container">
                <input type="text" id="searchInput" placeholder="What do you want to listen to?">
                <button onclick="performSearch()">Search</button>
            </div>

            <div class="content-split" id="contentSplit">
                <!-- Song List Area -->
                <div class="results-section" id="resultsSection">
                    <h2 id="sectionTitle">Top Charts</h2>
                    <div id="resultsList" class="song-list">
                        <div class="loading-text">Loading Charts...</div>
                    </div>
                </div>
                
                <!-- Lyrics Panel (Collapsible) -->
                <div class="lyrics-section" id="lyricsSection">
                    <h2>Lyrics</h2>
                    <div id="lyricsContainer" class="lyrics-container">
                        <p class="lyrics-placeholder">Lyrics will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Bar -->
    <div class="player-bar">
        <div class="now-playing">
            <div class="img-container">
                <img id="albumArt" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="">
                <div id="loadingOverlay" class="loading-overlay" style="display:none;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            <div class="track-info">
                <div id="trackName" class="track-name">Not Playing</div>
                <div id="artistName" class="artist-name"></div>
            </div>
            <i id="playerLikeBtn" class="far fa-heart like-btn-player" onclick="toggleLikeCurrent()"></i>
        </div>
        
        <div class="player-controls">
            <div class="control-buttons">
                <button onclick="seek(-10)" class="step"><i class="fas fa-backward"></i></button>
                <button id="playPauseBtn" onclick="togglePlay()"><i class="fas fa-play-circle"></i></button>
                <button onclick="seek(10)" class="step"><i class="fas fa-forward"></i></button>
            </div>
            <div class="progress-container">
                <span id="currentTime">0:00</span>
                <input type="range" id="progressBar" value="0" max="100">
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="volume-controls">
            <!-- Lyrics Toggle Button -->
            <i id="lyricsToggleBtn" class="fas fa-microphone lyrics-icon active" onclick="toggleLyricsPanel()" title="Toggle Lyrics"></i>
            <div class="separator"></div>
            <i class="fas fa-volume-up"></i>
            <input type="range" min="0" max="1" step="0.1" value="1" onchange="setVolume(this.value)">
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const lyricsContainer = document.getElementById('lyricsContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        let currentLyrics = []; 
        let currentSong = null; 
        let isLyricsOpen = true; // Default state

        window.onload = loadCharts;

        // --- LOADING STATES ---
        // Listen for audio events to toggle the loading spinner
        audioPlayer.addEventListener('waiting', () => {
            loadingOverlay.style.display = 'flex';
            updatePlayButton(false); // Show play icon while buffering
        });
        audioPlayer.addEventListener('playing', () => {
            loadingOverlay.style.display = 'none';
            updatePlayButton(true);
        });
        audioPlayer.addEventListener('canplay', () => {
            loadingOverlay.style.display = 'none';
            updatePlayButton(true);
        });

        // --- UI TOGGLES ---

        function toggleLyricsPanel() {
            isLyricsOpen = !isLyricsOpen;
            const split = document.getElementById('contentSplit');
            const lyricsSection = document.getElementById('lyricsSection');
            const toggleBtn = document.getElementById('lyricsToggleBtn');

            if (isLyricsOpen) {
                lyricsSection.style.display = 'flex';
                lyricsSection.classList.remove('hidden');
                split.classList.remove('expanded');
                toggleBtn.classList.add('active');
            } else {
                lyricsSection.style.display = 'none';
                lyricsSection.classList.add('hidden');
                split.classList.add('expanded');
                toggleBtn.classList.remove('active');
            }
        }

        // --- NAVIGATION ---
        function setActiveNav(id) {
            document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function focusSearch() { setActiveNav('nav-search'); document.getElementById('searchInput').focus(); }
        function showHome() { setActiveNav('nav-home'); document.getElementById('sectionTitle').innerText = "Top Charts"; loadCharts(); }
        function showFavourites() { setActiveNav('nav-library'); document.getElementById('sectionTitle').innerText = "Your Favourites"; renderSongList(getLikedSongs()); }

        async function loadCharts() {
            const list = document.getElementById('resultsList');
            list.innerHTML = '<div class="loading-text">Loading Top 10...</div>';
            try {
                const res = await fetch('/chart');
                const data = await res.json();
                renderSongList(data);
            } catch (e) { list.innerHTML = '<p>Error loading charts</p>'; }
        }

        async function performSearch() {
            setActiveNav('nav-search');
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            document.getElementById('sectionTitle').innerText = "Search Results";
            const list = document.getElementById('resultsList');
            list.innerHTML = '<div class="loading-text">Searching...</div>';
            try {
                const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                renderSongList(data);
            } catch (error) { list.innerHTML = '<p>Error fetching data.</p>'; }
        }

        function renderSongList(songs) {
            const list = document.getElementById('resultsList');
            list.innerHTML = '';
            if (songs.length === 0) { list.innerHTML = '<p>No songs found.</p>'; return; }
            const likedSongs = getLikedSongs();

            songs.forEach(song => {
                const isLiked = likedSongs.some(s => s.id === song.id);
                const heartClass = isLiked ? "fas fa-heart liked" : "far fa-heart";
                const item = document.createElement('div');
                item.className = 'song-item';
                item.innerHTML = `
                    <img src="${song.cover}" class="song-list-cover">
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist} â€¢ ${song.album}</div>
                    </div>
                    <div class="actions">
                        <i class="${heartClass} like-btn" onclick="toggleLike(event, '${encodeURIComponent(JSON.stringify(song))}')"></i>
                        <div class="song-duration">${formatTime(song.duration)}</div>
                    </div>
                `;
                item.onclick = (e) => { if (!e.target.classList.contains('like-btn')) loadSong(song); };
                list.appendChild(item);
            });
        }

        // --- PLAY LOGIC ---
        async function loadSong(song) {
            currentSong = song;
            // Update Text immediately
            document.getElementById('trackName').innerText = song.title;
            document.getElementById('artistName').innerText = song.artist;
            document.getElementById('artistName').innerText = "Downloading..."; // Temp status
            document.getElementById('albumArt').src = song.cover_xl;
            
            // Show Overlay
            loadingOverlay.style.display = 'flex';
            updatePlayerLikeBtn();

            lyricsContainer.innerHTML = '<div class="loading-lyrics">Searching Sources...</div>';
            currentLyrics = [];
            updatePlayButton(false);

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title, artist: song.artist, album: song.album,
                    artwork: [{ src: song.cover_xl, sizes: '512x512', type: 'image/jpeg' }]
                });
            }

            try {
                // Fetch Audio
                const audioRes = await fetch(`/play?artist=${encodeURIComponent(song.artist)}&title=${encodeURIComponent(song.title)}`);
                const audioData = await audioRes.json();
                
                if(audioData.error) { 
                    alert("Song not found"); 
                    document.getElementById('artistName').innerText = "Error";
                    loadingOverlay.style.display = 'none';
                    return; 
                }

                document.getElementById('artistName').innerText = song.artist; // Restore name
                audioPlayer.src = `/stream_proxy?url=${encodeURIComponent(audioData.url)}`;
                audioPlayer.play();
                // Overlay will be hidden by 'playing' event listener above

                // Fetch Lyrics
                const lyricsRes = await fetch(`/lyrics?artist=${encodeURIComponent(song.artist)}&title=${encodeURIComponent(song.title)}`);
                const lyricsData = await lyricsRes.json();
                if (lyricsData.lyrics) {
                    parseLyrics(lyricsData.lyrics);
                    renderLyrics();
                } else {
                    lyricsContainer.innerHTML = '<div class="lyrics-placeholder">No synced lyrics found.<br>Tried multiple sources.</div>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('artistName').innerText = song.artist;
                loadingOverlay.style.display = 'none';
            }
        }

        // --- LIKE LOGIC (Keep previous logic) ---
        function getLikedSongs() { return JSON.parse(localStorage.getItem('likedSongs') || '[]'); }
        function toggleLike(event, songStr) {
            event.stopPropagation();
            const song = JSON.parse(decodeURIComponent(songStr));
            const likedSongs = getLikedSongs();
            const index = likedSongs.findIndex(s => s.id === song.id);
            if (index === -1) { likedSongs.push(song); event.target.className = "fas fa-heart liked like-btn"; } 
            else { likedSongs.splice(index, 1); event.target.className = "far fa-heart like-btn"; if(document.getElementById('nav-library').classList.contains('active')) renderSongList(likedSongs); }
            localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
            updatePlayerLikeBtn();
        }
        function toggleLikeCurrent() {
            if (!currentSong) return;
            const likedSongs = getLikedSongs();
            const index = likedSongs.findIndex(s => s.id === currentSong.id);
            if (index === -1) likedSongs.push(currentSong); else likedSongs.splice(index, 1);
            localStorage.setItem('likedSongs', JSON.stringify(likedSongs));
            updatePlayerLikeBtn();
            if (document.getElementById('nav-library').classList.contains('active')) renderSongList(likedSongs);
        }
        function updatePlayerLikeBtn() {
            if(!currentSong) return;
            const isLiked = getLikedSongs().some(s => s.id === currentSong.id);
            document.getElementById('playerLikeBtn').className = isLiked ? "fas fa-heart like-btn-player liked" : "far fa-heart like-btn-player";
        }

        // --- LYRICS & AUDIO ---
        function parseLyrics(lrcString) {
            const lines = lrcString.split('\n');
            const regex = /^\[(\d{2}):(\d{2}\.\d{2})\](.*)/;
            currentLyrics = [];
            lines.forEach(line => {
                const match = line.match(regex);
                if (match && match[3].trim()) currentLyrics.push({ time: parseInt(match[1])*60 + parseFloat(match[2]), text: match[3].trim() });
            });
        }
        function renderLyrics() {
            lyricsContainer.innerHTML = '';
            currentLyrics.forEach((line, index) => {
                const p = document.createElement('p');
                p.innerText = line.text; p.id = `line-${index}`; p.className = 'lyric-line';
                p.onclick = () => { audioPlayer.currentTime = line.time; };
                lyricsContainer.appendChild(p);
            });
            const spacer = document.createElement('div'); spacer.style.height = "50%"; lyricsContainer.appendChild(spacer);
        }
        function syncLyrics(currentTime) {
            if (!currentLyrics.length) return;
            let activeIndex = -1;
            for (let i = 0; i < currentLyrics.length; i++) { if (currentTime >= currentLyrics[i].time) activeIndex = i; else break; }
            if (activeIndex !== -1) {
                document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('active'));
                const activeEl = document.getElementById(`line-${activeIndex}`);
                if (activeEl) { activeEl.classList.add('active'); activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            }
        }
        function togglePlay() { if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause(); }
        function seek(s) { audioPlayer.currentTime += s; }
        function updatePlayButton(p) { playPauseBtn.innerHTML = p ? '<i class="fas fa-pause-circle"></i>' : '<i class="fas fa-play-circle"></i>'; }
        audioPlayer.ontimeupdate = () => {
            if (audioPlayer.duration) {
                progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('currentTime').innerText = formatTime(audioPlayer.currentTime);
                document.getElementById('duration').innerText = formatTime(audioPlayer.duration);
                syncLyrics(audioPlayer.currentTime);
            }
        };
        progressBar.oninput = () => { audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration; }
        function formatTime(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        function setVolume(v) { audioPlayer.volume = v; }
        document.getElementById('searchInput').addEventListener("keypress", (e) => { if (e.key === "Enter") performSearch(); });
    </script>
</body>
</html>